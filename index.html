<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GO Enrichment Dotplot Demo</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    svg { width: 100%; height: 650px; }
    .tooltip {
      position: absolute;
      text-align: left;
      padding: 8px;
      font-size: 13px;
      background: rgba(0,0,0,0.7);
      color: white;
      border-radius: 4px;
      pointer-events: none;
    }
    .legend {
      font-size: 12px;
    }
    #exportBtn {
      margin-top: 10px;
      padding: 6px 12px;
      background: #444;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>GO Enrichment Dotplot</h1>
  <p>Bubble size: gene count Â· Color: -log10(FDR)</p>
  <div id="error"></div>
  <svg id="chart"></svg>
  <button id="exportBtn">ðŸ“¤ Export SVG</button>
  <div id="tooltip" class="tooltip" style="display: none;"></div>

  <script>
    const tooltip = d3.select("#tooltip");

    d3.csv('go_dotplot.csv', d3.autoType).then(data => {
      if (!data || data.length === 0) {
        document.getElementById('error').textContent = "Data file is empty or could not be read.";
        return;
      }

      const svg = d3.select("#chart");
      const width = 960;
      const height = 650;
      const margin = { top: 40, right: 30, bottom: 60, left: 200 };

      const innerWidth = width - margin.left - margin.right;
      const innerHeight = height - margin.top - margin.bottom;

      const x = d3.scaleLinear()
        .domain([0, d3.max(data, d => d["Gene Ratio"])]).nice()
        .range([0, innerWidth]);

      const y = d3.scaleBand()
        .domain(data.map(d => d["GO Term"]))
        .range([0, innerHeight])
        .padding(0.3);

      const r = d3.scaleSqrt()
        .domain(d3.extent(data, d => d["Gene Count"]))
        .range([4, 18]);

      const color = d3.scaleSequential()
        .domain(d3.extent(data, d => d["-log10(FDR)"]).reverse())
        .interpolator(d3.interpolateRdBu);

      const g = svg.append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);

      g.selectAll('circle')
        .data(data)
        .enter()
        .append('circle')
        .attr('cx', d => x(d["Gene Ratio"]))
        .attr('cy', d => y(d["GO Term"]) + y.bandwidth() / 2)
        .attr('r', d => r(d["Gene Count"]))
        .attr('fill', d => color(d["-log10(FDR)"]))
        .attr('opacity', 0.9)
        .on("mouseover", function (event, d) {
          tooltip.style("display", "block")
                 .html(`<strong>${d["GO Term"]}</strong><br>
                        Gene Ratio: ${d["Gene Ratio"]}<br>
                        Gene Count: ${d["Gene Count"]}<br>
                        -log10(FDR): ${d["-log10(FDR)"].toFixed(2)}`);
        })
        .on("mousemove", function (event) {
          tooltip.style("left", (event.pageX + 10) + "px")
                 .style("top", (event.pageY - 28) + "px");
        })
        .on("mouseout", function () {
          tooltip.style("display", "none");
        });

      g.append('g')
        .attr('transform', `translate(0,${innerHeight})`)
        .call(d3.axisBottom(x));

      g.append('g')
        .call(d3.axisLeft(y));

      const legend = svg.append("g")
        .attr("transform", `translate(${width - 120},${margin.top})`)
        .attr("class", "legend");

      const sizeVals = [10, 40, 70];
      sizeVals.forEach((d, i) => {
        legend.append("circle")
          .attr("cy", i * 30)
          .attr("r", r(d))
          .attr("fill", "#999")
          .attr("cx", 0);
        legend.append("text")
          .attr("x", 20)
          .attr("y", i * 30 + 5)
          .text(`Count: ${d}`);
      });

      const defs = svg.append("defs");
      const linearGradient = defs.append("linearGradient")
        .attr("id", "color-gradient");

      linearGradient.selectAll("stop")
        .data([
          { offset: "0%", color: d3.interpolateRdBu(1) },
          { offset: "100%", color: d3.interpolateRdBu(0) }
        ])
        .enter()
        .append("stop")
        .attr("offset", d => d.offset)
        .attr("stop-color", d => d.color);

      svg.append("rect")
        .attr("x", width - 160)
        .attr("y", height - 50)
        .attr("width", 120)
        .attr("height", 10)
        .style("fill", "url(#color-gradient)");

      svg.append("text")
        .attr("x", width - 160)
        .attr("y", height - 55)
        .text("-log10(FDR)")
        .style("font-size", "12px");

      document.getElementById("exportBtn").addEventListener("click", () => {
        const serializer = new XMLSerializer();
        const source = serializer.serializeToString(svg.node());
        const blob = new Blob([source], { type: "image/svg+xml;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "go_dotplot.svg";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });
    }).catch(err => {
      document.getElementById('error').textContent = "Failed to load or parse CSV: " + err.message;
      console.error("CSV Load Error:", err);
    });
  </script>
</body>
</html>
