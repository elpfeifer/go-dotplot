<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GO Enrichment Dotplot (Interactive)</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #controls { margin-bottom: 20px; }
    label { margin-right: 8px; }
    svg { border: 1px solid #ccc; display: block; margin-top: 10px; }
    .tooltip {
      position: absolute;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 6px;
      font-size: 12px;
      pointer-events: none;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <h1>GO Enrichment Dotplot</h1>

  <div id="controls">
    <br>
    <fieldset style="margin-top: 10px; padding: 10px; border: 1px solid #ccc;">
      <legend><strong>Filter Options</strong></legend>
      <label>Gene Count:
        <input type="range" id="minCount" min="0" max="100" value="0" step="1">
        to
        <input type="range" id="maxCount" min="0" max="100" value="80" step="1">
      </label><br>
      <label>Gene Ratio:
        <input type="range" id="minRatio" min="0" max="1" value="0" step="0.01">
        to
        <input type="range" id="maxRatio" min="0" max="1" value="0.05" step="0.01">
      </label><br>
      <label>-log10(FDR):
        <input type="range" id="minFDR" min="0" max="10" value="0" step="0.1">
        to
        <input type="range" id="maxFDR" min="0" max="10" value="4" step="0.1">
      </label><br>
    </fieldset>
    <label>
      <input type="checkbox" id="showLegends" checked>
      Show legends
    </label>
    <label>
      <input type="checkbox" id="moveLegend">
      Move size legend to bottom
    </label>

    <label>Upload CSV:
      <input type="file" id="fileInput" accept=".csv">
    </label>
    <label>Font size:
      <input type="range" id="fontSize" min="10" max="24" value="12">
    </label>
    <label>Color scale:
      <select id="colorScale">
        <option value="interpolateRdBu">RdBu</option>
        <option value="interpolateViridis">Viridis</option>
        <option value="interpolatePlasma">Plasma</option>
        <option value="interpolateInferno">Inferno</option>
        <option value="interpolateMagma">Magma</option>
        <option value="RedBlueClassic">Red-Blue Classic</option>
        <option value="Custom">Custom</option>
      </select>
      <label id="customColorInputs" style="display: none;">
        Start color: <input type="color" id="startColor" value="#ff0000">
        End color: <input type="color" id="endColor" value="#0000ff">
      </label>
        <option value="interpolateRdBu">RdBu</option>
        <option value="interpolateViridis">Viridis</option>
        <option value="interpolatePlasma">Plasma</option>
        <option value="interpolateInferno">Inferno</option>
        <option value="interpolateMagma">Magma</option>
      </select>
    </label>
    <label>Width:
      <input type="range" id="chartWidth" min="600" max="1200" value="960">
    </label>
    <label>Height:
      <input type="range" id="chartHeight" min="400" max="1000" value="650">
    </label>
  </div>

  <svg id="chart"></svg>
  <div class="tooltip" id="tooltip" style="display: none;"></div>

  <script>
    const tooltip = d3.select("#tooltip");
    let currentData = [];

    function drawChart(data, config) {
      currentData = data;

      const filteredData = data.filter(d =>
        d["Gene Count"] >= +document.getElementById("minCount").value &&
        d["Gene Count"] <= +document.getElementById("maxCount").value &&
        d["Gene Ratio"] >= +document.getElementById("minRatio").value &&
        d["Gene Ratio"] <= +document.getElementById("maxRatio").value &&
        d["-log10(FDR)"] >= +document.getElementById("minFDR").value &&
        d["-log10(FDR)"] <= +document.getElementById("maxFDR").value
      );
      
      const data = filteredData;
      if (data.length === 0) {
        svg.append("text")
          .attr("x", 100)
          .attr("y", 100)
          .text("No data available in selected filter range.")
          .style("font-size", "16px")
          .style("fill", "red");
        return;
      }
    


      const svg = d3.select("#chart");
      svg.selectAll("*").remove();

      const width = config.width;
      const height = config.height;
      const fontSize = config.fontSize;
      const margin = { top: 40, right: 30, bottom: 60, left: 200 };

      svg.attr("width", width).attr("height", height);

      const innerWidth = width - margin.left - margin.right;
      const innerHeight = height - margin.top - margin.bottom;

      const x = d3.scaleLinear()
        .domain([0, d3.max(data, d => d["Gene Ratio"])]).nice()
        .range([0, innerWidth]);

      const y = d3.scaleBand()
        .domain(data.map(d => d["GO Term"]))
        .range([0, innerHeight])
        .padding(0.3);

      const r = d3.scaleSqrt()
        .domain(d3.extent(data, d => d["Gene Count"]))
        .range([4, 18]);

      
      let color;
      if (config.colorScale === "RedBlueClassic") {
        color = d3.scaleLinear()
          .domain(d3.extent(data, d => d["-log10(FDR)"]))
          .range(["red", "blue"]);
      } else if (config.colorScale === "Custom") {
        const start = document.getElementById("startColor").value;
        const end = document.getElementById("endColor").value;
        color = d3.scaleLinear()
          .domain(d3.extent(data, d => d["-log10(FDR)"]))
          .range([start, end]);
      } else {
        color = d3.scaleSequential()
          .domain(d3.extent(data, d => d["-log10(FDR)"]).reverse())
          .interpolator(d3[config.colorScale]);
      }
    
        .domain(d3.extent(data, d => d["-log10(FDR)"]).reverse())
        .interpolator(d3[config.colorScale]);

      const g = svg.append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);

      g.selectAll('circle')
        .data(data)
        .enter()
        .append('circle')
        .attr('cx', d => x(d["Gene Ratio"]))
        .attr('cy', d => y(d["GO Term"]) + y.bandwidth() / 2)
        .attr('r', d => r(d["Gene Count"]))
        .attr('fill', d => color(d["-log10(FDR)"]))
        .attr('opacity', 0.9)
        .on("mouseover", function (event, d) {
          tooltip.style("display", "block")
            .html(`<strong>${d["GO Term"]}</strong><br>
                   Gene Ratio: ${d["Gene Ratio"]}<br>
                   Gene Count: ${d["Gene Count"]}<br>
                   -log10(FDR): ${d["-log10(FDR)"].toFixed(2)}`);
        })
        .on("mousemove", function (event) {
          tooltip.style("left", (event.pageX + 10) + "px")
                 .style("top", (event.pageY - 28) + "px");
        })
        .on("mouseout", function () {
          tooltip.style("display", "none");
        });

      g.append("g")
        .attr("transform", `translate(0,${innerHeight})`)
        .call(d3.axisBottom(x).tickSizeOuter(0))
        .selectAll("text")
        .style("font-size", fontSize + "px");

      g.append("g")
        .call(d3.axisLeft(y))
        .selectAll("text")
        .style("font-size", fontSize + "px");
    }

    function loadCSVFromFile(file) {
      const reader = new FileReader();
      reader.onload = function (e) {
        const parsed = d3.csvParse(e.target.result, d3.autoType);
        drawChart(parsed, getConfig());
      };
      reader.readAsText(file);
    }

    function getConfig() {
      return {
        fontSize: +document.getElementById("fontSize").value,
        colorScale: document.getElementById("colorScale").value,
        width: +document.getElementById("chartWidth").value,
        height: +document.getElementById("chartHeight").value
      };
    }

    document.getElementById("fileInput").addEventListener("change", (e) => {
      if (e.target.files.length > 0) {
        loadCSVFromFile(e.target.files[0]);
      }
    });

    document.querySelectorAll("#fontSize, #colorScale, #chartWidth, #chartHeight, #startColor, #endColor")
      .forEach(el => el.addEventListener("input", () => drawChart(currentData, getConfig())));

    // Load default file
    d3.csv("go_dotplot.csv", d3.autoType).then(data => {
      drawChart(data, getConfig());
    });
  </script>
</body>
</html>

<script>
  document.getElementById("colorScale").addEventListener("change", function () {
    const showCustom = this.value === "Custom";
    document.getElementById("customColorInputs").style.display = showCustom ? "inline-block" : "none";
  });
</script>

<script>

document.querySelectorAll("#minCount, #maxCount, #minRatio, #maxRatio, #minFDR, #maxFDR, #showLegends, #moveLegend")
  .forEach(el => el.addEventListener("input", () => drawChart(currentData, getConfig())));

</script>
